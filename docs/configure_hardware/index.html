<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.66">
<title data-react-helmet="true">Configuring hardware_config.h | BlueMicro nRF52 Keyboard Firmware</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Configuring hardware_config.h | BlueMicro nRF52 Keyboard Firmware"><meta data-react-helmet="true" name="description" content="Configuring your keyboard - Part 1: Hardware Definition"><meta data-react-helmet="true" property="og:description" content="Configuring your keyboard - Part 1: Hardware Definition"><meta data-react-helmet="true" property="og:url" content="http://bluemicro.jpconstantineau.com//docs/configure_hardware"><link data-react-helmet="true" rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAADzVwEA01UhAO6OXwDzUgcA+JZ6APjUxAD4n4IA81ECAOjo6AD35dcA81cCAPRXGwD4oX0A+c+6APNpMwDLn40A/fHnAPX19QD27+0A+unlANTBugD88+oA81MnAPJJAQD++PUA+dPAAP3p3QDzSQEA/e/lAPNLDADHk34A8kAKAL2vrAD96+AA+JhuAP7x6AD5qoYA81IBAP328wDzUhoA+a2GAPNVAQDyWAEA81gBAPJJAgD//v4A9GQqAPz08QD839EA8k8CAPWVZwDtWhUA7l4SAO1RBQD97uEAx2g6APenfwD+7uEA/efcAPJVAgD97eQA70gOAP7t5AD4zrcA/ePXAPiWbQD96d8A8kQJAOp1PgDXnooA9G0zAPnw7QD08vAA+rmgALd8ZwD4zrgA9GIpAPJKAQD5qIYA7V0fAORnNQDzUwEA2djYAPNWAQD87eYA81kBAPjOuQD+8OYA9fT0APBNAgDxNgkA/ezhAPVuMgD5sY8A4WcuAPmwkgD4lG0A81kCAMaUgADHlIAA////APJFCQDwUAMA8WMYAO/UywDtTwYA9X1LAPmxkADySyIAyJJ+ALWqpwDyVCoA0F0rAM1vQwDBmokA/uvdAOmFXwDxTgEA+KqDAPvj2wDzTgEAxV00APRlLAD25d4Awb28APF6RAD97OMA81QBAPFFAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGRkZGRkEQgIEWRkZGRkZGRkZGRIRXFwN0p8ZGRkZGRkZGQSUDsdKBs7AW5kZGRkZGRkdCoKQyMkGyt5UmRkZGRkR2kDB2VXPE4sNSBkZGRkZAUXa11aNhYVOHVyZGRkZGQNfwtABiFBW0YpYmRkZGRkS1MpJzAtfnolVR5kZGRkZD8ACk0EZEmACmFtZGRkZGRWU01gQhg6XywrY2RkZGRkGXgiHG9zbBB2MQ9kZGRkZFRZalwfOQwaDmYUZGRkZGRkfSkpZRA+TFFeWGRkZGRkZHdnAD0JLiU0aGRkZGRkZGRkZDJPRDMCe2RkZGRkZGRkZGRkJhMvZGRkZGRkZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="><link data-react-helmet="true" rel="canonical" href="http://bluemicro.jpconstantineau.com//docs/configure_hardware"><link rel="stylesheet" href="/styles.dcb218f7.css">
<link rel="preload" href="/styles.d7666fba.js" as="script">
<link rel="preload" href="/runtime~main.8a8a4059.js" as="script">
<link rel="preload" href="/main.a1a18cba.js" as="script">
<link rel="preload" href="/1.4fc60004.js" as="script">
<link rel="preload" href="/2.40c9270e.js" as="script">
<link rel="preload" href="/56.c29990b1.js" as="script">
<link rel="preload" href="/57.8fb808ae.js" as="script">
<link rel="preload" href="/935f2afb.35880b81.js" as="script">
<link rel="preload" href="/17896441.12c8cb39.js" as="script">
<link rel="preload" href="/5fae6b63.474b09ba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="BlueMicro Logo"><strong class="navbar__title">BlueMicro nRF52 Keyboard Firmware</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="http://nrf52.jpconstantineau.com/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">BlueMicro Hardware</a><a href="https://github.com/jpconstantineau/Community_nRF52_Arduino/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Community nRF52 Arduino Support</a><a href="https://github.com/jpconstantineau/BlueMicro_BLE" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.png" alt="BlueMicro Logo"><strong class="navbar__title">BlueMicro nRF52 Keyboard Firmware</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="http://nrf52.jpconstantineau.com/docs/" target="_blank" rel="noopener noreferrer" class="menu__link">BlueMicro Hardware</a></li><li class="menu__list-item"><a href="https://github.com/jpconstantineau/Community_nRF52_Arduino/wiki" target="_blank" rel="noopener noreferrer" class="menu__link">Community nRF52 Arduino Support</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/jpconstantineau/BlueMicro_BLE" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/bluetooth_firmware">Bluetooth First</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/hardware">Supported Processors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/keyboards">Keyboards</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/features">Features Compared</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">How To</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools">Installing Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/add">Adding a new Keyboard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/understand_gpios">Understand GPIOs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/configure_hardware">Configuring hardware_config.h</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/configure_keyboard">Configuring keyboard_config.h</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/configure_keymap">Configuring keymap.h.cpp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/keymaps">Configuring your own keymap</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/build">Building Firmware</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flash">Flashing Firmware to your keyboard</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/customize_BSP">Customizing Adafruit BSP</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Keycodes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/keycodes_basic">Basic Keycodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/keycodes_extended">Extended Keycodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/keycodes_firmware">Firmware-only Keycodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/keycodes_hardware">Hardware-specific Keycodes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_base">Basic setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_keycodes">Finding Keycodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_layers">Layers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_adjust">Hidden Layers (tri-layers)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_modkeys">Modified Keys</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_oneshottoggle">One-Shot Toggles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_taphold">Tap/Hold for Modifiers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_tapholdlayer">Tap/Hold for Layers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_spacecadet">Space Cadet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_flashing">Flashing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_keymapswitch">Switching Keymaps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tut_macros">Macros</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contributing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/style_guide">Documentation Style Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/docsa">Contributing to BlueMicro_BLE</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Configuring hardware_config.h</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configuring-your-keyboard---part-1-hardware-definition"></a>Configuring your keyboard - Part 1: Hardware Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuring-your-keyboard---part-1-hardware-definition" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="matrix-definition"></a>Matrix Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#matrix-definition" title="Direct link to heading">#</a></h3><p>Most keyboards use a matrix of columns and rows to scan each key.  You will need to refer to the keyboard schematic to identify how many columns and rows your keyboard uses for it&#x27;s scanning matrix.  The scanning matrix may differ from the keyboard layout.  For example, a 4x12 matrix uses 16 GPIOs and allows for 48 keys to be scanned.  A 8x8 matrix also uses 16 GPIOs but will allow 64 keys to be scanned.  The mapping of each key in the scanning matrix to the keyboard layout is done in the KEYMAP macro definition in keyboard_config.h.</p><p><img src="http://bluemicro.jpconstantineau.com/img/keyboardmatrix.png" alt="keyboard matrix"></p><p>In the image above, we see that this keyboard has a matrix of 4 rows, with 7 columns.  The direction of the diodes goes from the columns to the rows.  With this information, we can define the following:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_ROWS 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_COLS 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DIODE_DIRECTION COL2ROW</span></div></div></div></div></div><p>Next, we need to identify how each row and column are mapped to the microntroller on board of the nRF52 module you use.  Since most DIY keyboards use the Arduino Pro Micro as its controller, we are using such an example.</p><p><img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>With the information from both the keyboard and controller schamatics, we can map each row and column to the GPIO and using the formula shown in the previous section, we can define the configuration needed: </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_ROW_PINS {13, 24, 9, 10 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_COL_PINS {26, 29, 2, 45, 3, 28, 43 }</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="status-leds"></a>Status LEDs<a aria-hidden="true" tabindex="-1" class="hash-link" href="#status-leds" title="Direct link to heading">#</a></h3><p>Most controllers will have 1 or 2 LEDs to let the user know of the status of the board.  To configure the firmware to use these LEDs, you need to set at least the PIN definition for the LED.
By default, when <code>STATUS_BLE_LED_PIN</code> or <code>STATUS_KB_LED_PIN</code> are defined, both the <code>ACTIVE</code> and <code>POLARITY</code> settings will default to 1.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_BLE_LED_PIN  19  //blue = 0.19</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  BLE_LED_ACTIVE 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  BLE_LED_POLARITY 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_PIN 17  //red = 0.17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_ACTIVE 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_POLARITY 1</span></div></div></div></div></div><p>If you want to keep the definition of the PIN but want to disable the use of the specific status LED, you need to set the <code>ACTIVE</code> to <code>0</code>.  </p><p>By default, setting a <code>1</code> on the GPIO will turn on the LED.  If this logic is reversed, set <code>POLARITY</code> to <code>0</code>.</p><p>If your board does not have the LED defined but it&#x27;s status does not change, you need to configure the PIN so that it can be updated to match the state of the keyboard.</p><p>Note that when going to sleep, the enabled pins will go in a low power mode (INPUT) and will turn off the LEDs.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="battery-monitoring"></a>Battery Monitoring<a aria-hidden="true" tabindex="-1" class="hash-link" href="#battery-monitoring" title="Direct link to heading">#</a></h3><p>Battery Monitoring is a function that&#x27;s specific to the controller you use.  Most controllers implement an on-board battery charger and battery monitoring voltage divider and connect this divider to an analog input.  Such a configuration is shown below:</p><p><img src="http://bluemicro.jpconstantineau.com/img/batterymonitoring.png" alt="Battery Monitoring"></p><p>From the schematic, we identify that the connection point of the voltage divider is connected to 0.31. This leads to this definition:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BATTERY_TYPE BATT_LIPO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define VBAT_PIN  31</span></div></div></div></div></div><p>If a non-rechargeable CR2032 (3V) powers your keyboard and the battery is directly connected to the nRF52 chip, you still need to define a <code>VBATT_PIN</code>  but since the nrf52 chip can measure its own supply voltage, it will not use this configuration. All you need to do is to use this definition:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BATTERY_TYPE BATT_CR2032</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="external-vcc-switching"></a>External VCC Switching<a aria-hidden="true" tabindex="-1" class="hash-link" href="#external-vcc-switching" title="Direct link to heading">#</a></h3><p>Some controllers implement switching of external VCC to ensure low power consumption.  Polarity of switching will depend on the hardware implementation.  Refer to the controller documentation and/or schematic to identify if VCC switching is available, which GPIO it is connected to and polarity of the switch.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_PIN 12</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_POLARITY_ON 1</span></div></div></div></div></div><p>If <code>VCC_PIN</code> is left undefined, VCC switching functionality will not be enabled in the firmware.</p><p>By default, <code>VCC_POLARITY_ON</code> is defined with 1. You only need to define it if polarity is reversed. (replace 1 with 0)</p><p>By default, the firmware will turn on external VCC when booting up and will turn off External VCC when going to sleep.  If you want to force external VCC to be off at bootup, you can add this definition to your <strong>hardware_config.h</strong> file.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_DEFAULT_ON 0</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="lipo-charger-switching"></a>LiPo Charger Switching<a aria-hidden="true" tabindex="-1" class="hash-link" href="#lipo-charger-switching" title="Direct link to heading">#</a></h3><p>Some controllers implement turning off the LiPo Charger to allow for a more precise battery level measurement.  Switching polarity will depend on the hardware implementation.  Refer to the controller documentation and/or schematic to identify if charger switching is available, which GPIO it is connected to and polarity to enable charging.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">     #define CHARGER_PIN  5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     #define CHARGER_POLARITY_ON 0</span></div></div></div></div></div><p>If <code>CHARGER_PIN</code> is left undefined, charger switching functionality will not be enabled in the firmware. By default, the firmware will turn on charger when booting up and will not change it at any time.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="backlight-pwm-led-definition"></a>Backlight PWM LED Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#backlight-pwm-led-definition" title="Direct link to heading">#</a></h3><p>Some keyboards have backlit keys using LEDs controlled by a central mosfet.  The brightness of these LEDs can be modulated using Pulse Width Modulation (PWM). When referring to the keyboard and controller schematics above, we see that GPIO 1.06 is connected to the LED Backlight.</p><p> <img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>This enables setting up the following configuration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define BACKLIGHT_LED_PIN 38</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define BACKLIGHT_PWM_ON 1 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define DEFAULT_PWM_VALUE 10000  // Reduce max PWM to 10000 out of 63351 (0x7FFF)</span></div></div></div></div></div><p>If <code>BACKLIGHT_LED_PIN</code> is left undefined, LED functionality will not be enabled in the firmware.
<code>BACKLIGHT_PWM_ON</code> is optional. If <code>BACKLIGHT_LED_PIN</code> is defined, but you want to turn off LED functionality, you can do so by setting <code>BACKLIGHT_PWM_ON</code> to 0.
If <code>DEFAULT_PWM_VALUE</code> is left undefined, the default value will be that of maximum PWM value of 63351 (0x7FFF).  This will turn on LEDs on fully.</p><p>Turning on the PWM peripheral on the nRF52 chip uses approximately 0.5mA, not including the power used by the LED themselves.  As such, when the PWM value is set to 0, the firmware turns off the PWM peripheral it uses for controlling the brightness of the LEDs. It does the same prior to going to sleep. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="rgb-led-definition"></a>RGB LED Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#rgb-led-definition" title="Direct link to heading">#</a></h3><p>Some keyboards have RGB LEDs.  These LEDs are controlled through a single data line. When referring to the keyboard and controller schematics above, we see that GPIO 0.06 is connected to the RGB WS2812 LEDs.</p><p> <img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>This enables setting up the following configuration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_PIN 6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_COUNT 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_ON 1 </span></div></div></div></div></div><p>If <code>WS2812B_LED_PIN</code> is left undefined, LED functionality will not be enabled in the firmware.
If <code>WS2812B_LED_ON</code> is set to 0, RGB functionality will not be enabled in the firmware. Note that this will not power down VCC power to the RGB LEDs, impacting power consumption of your keyboard.  External VCC to the RGB LEDs is controlled through the <strong>External VCC Switch</strong> functionality described above.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="oled-definition"></a>OLED Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#oled-definition" title="Direct link to heading">#</a></h3><p>To Do - Still being implemented.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define OLED_SDA_PIN        25</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define OLED_SCL_PIN        26</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="rotary-encoder-definition"></a>Rotary Encoder Definition<a aria-hidden="true" tabindex="-1" class="hash-link" href="#rotary-encoder-definition" title="Direct link to heading">#</a></h3><p>Currently implemented for a single Rotary encoder per side/half.</p><p>Add these lines to your <code>hardware_config.h</code></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_A_PIN  26 </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_B_PIN  30 </span></div></div></div></div></div><p>From a hardware point of view, the A an B lines of the encoder should be wired directly to the nRF52 GPIO. The C (or common) line should be wired to ground. By default, the configuration uses the hardware QDEC peripheral (Quadrature Decoder) that&#x27;s part of the nRF52 SoC and uses callbacks to handle rotation.  The Adafruit library supports sofware interrupts for 4 encoders but this has not been fully tested.  This limit on the number of encoders supported can be modified in the <a href="https://github.com/jpconstantineau/Adafruit_nRF52_Arduino/blob/master/libraries/RotaryEncoder/SwRotaryEncoder.cpp" target="_blank" rel="noopener noreferrer">library</a>.  Refer to the examples in the library if you want to implement multiple encoders.</p><p>You will need to add a few things to your keymap.h file.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &quot;KeyScanner.h&quot;  // include at the top with the other includes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void encoder_callback(int step); // add right after void setupKeymap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>You will also need to add a few things to your keymap.cpp file.  For example, you will need to add the following 3 lines in the <code>setupKeymap()</code> function:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Code below makes sure that the encoder gets configured.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RotaryEncoder.begin(ENCODER_PAD_A, ENCODER_PAD_B);    // Initialize Encoder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RotaryEncoder.setCallback(encoder_callback);    // Set callback</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  RotaryEncoder.start();    // Start encoder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>You will need to add the  <code>encoder_callback()</code> function:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-c++ codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">void encoder_callback(int step)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if ( step &gt; 0 )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      switch(KeyScanner::localLayer)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         // case _L0: break;  // commented out to revert to default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          case _L1: break;    // in Layer 1, send nothing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          case _L2: break;    // in Layer 2, send nothing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          default: KeyScanner::add_to_encoderKeys(KC_AUDIO_VOL_UP);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      switch(KeyScanner::localLayer)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         // case _L0: break;   // commented out to revert to default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          case _L1: break;     // in Layer 1, send nothing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          case _L2: break;     // in Layer 2, send nothing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          default: KeyScanner::add_to_encoderKeys(KC_AUDIO_VOL_DOWN);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>If you rotate in one direction and the keycodes are for the other direction, simply change the <code>if ( step &gt; 0 )</code> statement to <code>if ( step &lt; 0 )</code> or swap the keycodes around.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/configuring_firmware_1.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/understand_gpios"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Understand GPIOs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/configure_keyboard"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuring keyboard_config.h Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-your-keyboard---part-1-hardware-definition" class="table-of-contents__link">Configuring your keyboard - Part 1: Hardware Definition</a><ul><li><a href="#matrix-definition" class="table-of-contents__link">Matrix Definition</a></li><li><a href="#status-leds" class="table-of-contents__link">Status LEDs</a></li><li><a href="#battery-monitoring" class="table-of-contents__link">Battery Monitoring</a></li><li><a href="#external-vcc-switching" class="table-of-contents__link">External VCC Switching</a></li><li><a href="#lipo-charger-switching" class="table-of-contents__link">LiPo Charger Switching</a></li><li><a href="#backlight-pwm-led-definition" class="table-of-contents__link">Backlight PWM LED Definition</a></li><li><a href="#rgb-led-definition" class="table-of-contents__link">RGB LED Definition</a></li><li><a href="#oled-definition" class="table-of-contents__link">OLED Definition</a></li><li><a href="#rotary-encoder-definition" class="table-of-contents__link">Rotary Encoder Definition</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/ecnCR9P" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCFpGp4hHe03nvF9c8_gF_jA" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/jpconstantineau/BlueMicro_BLE" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Pierre Constantineau. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.d7666fba.js"></script>
<script src="/runtime~main.8a8a4059.js"></script>
<script src="/main.a1a18cba.js"></script>
<script src="/1.4fc60004.js"></script>
<script src="/2.40c9270e.js"></script>
<script src="/56.c29990b1.js"></script>
<script src="/57.8fb808ae.js"></script>
<script src="/935f2afb.35880b81.js"></script>
<script src="/17896441.12c8cb39.js"></script>
<script src="/5fae6b63.474b09ba.js"></script>
</body>
</html>